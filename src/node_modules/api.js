import axios from 'axios';

const token = localStorage.getItem('jwt');

const Api = axios.create({
    baseURL: process.env.REACT_APP_BASE_URL,
    headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Authorization': token ? `Token ${token}` : '',
    },
});

const Auth = {
    current: () =>
        Api.get('/user'),
    login: (email, password) =>
        Api.post('/users/login', { user: { email, password } }),
    register: (username, email, password) =>
        Api.post('/users', { user: { username, email, password } }),
    save: user =>
        Api.put('/user', { user }),
};

const Tags = {
    getAll: () =>
        Api.get('/tags'),
};

const Articles = {
    get: (slug) =>
        Api.get(`/articles/${slug}`),
    getAll: (offset, limit = 10) =>
        Api.get(`/articles?offset=${offset ? offset * limit : 0}&limit=${limit}`),
    like: (slug) =>
        Api.post(`/articles/${slug}/favorite`),
    unlike: (slug) =>
        Api.delete(`/articles/${slug}/favorite`),
    byTag: (tag, page, limit = 10) =>
        Api.get(`/articles?tag=${encodeURIComponent(tag)}&offset=${page ? page * limit : 0}&limit=${limit}`),
};

const Comments = {
    create: (slug, comment) =>
        Api.post(`/articles/${slug}/comments`, { comment }),
    delete: (slug, commentId) =>
        Api.delete(`/articles/${slug}/comments/${commentId}`),
    forArticle: (slug) =>
        Api.get(`/articles/${slug}/comments`),
};

const baseUrl = 'https://conduit.productionready.io/api';

const requests = {
    del: url => fetch(`${baseUrl}${url}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json;charset=utf-8',
            'Authorization': `Token ${token}`,
        },
    }).then(response => response.json()),

    get: (url) => fetch(`${baseUrl}${url}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json;charset=utf-8',
            'Authorization': `Token ${token}`,
        },
    }).then(response => response.json()),

    put: (url, body) => fetch(`${baseUrl}${url}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json;charset=utf-8',
            'Authorization': `Token ${token}`,
        },
        body: JSON.stringify(body),
    }).then(response => response.json()),

    post: (url, body) => fetch(`${baseUrl}${url}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json;charset=utf-8',
            'Authorization': `Token ${token}`,
        },
        body: JSON.stringify(body),
    }).then(response => response.json()),
};

const Profile = {
    follow: (username) => requests.post(`/profiles/${username}/follow`),
    get: (username) => requests.get(`/profiles/${username}`),
    unfollow: (username) => requests.del(`/profiles/${username}/follow`),
};

export default {
    Profile,
    Articles,
    Tags,
    Comments,
    Auth,
};